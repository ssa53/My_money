<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>간단 가계부 - 로그인</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-header">
            <h1>간단 가계부</h1>
            <p>가계부를 시작해보세요</p>
        </div>
        
        <!-- 메인 로그인 폼 -->
        <form id="login-form" class="main-auth-form">
            <div class="form-group">
                <input type="email" id="login-email" placeholder="이메일" required>
            </div>
            <div class="form-group">
                <input type="password" id="login-password" placeholder="비밀번호" required>
            </div>
            <button type="submit" class="login-btn">로그인</button>
        </form>
        
        <!-- 하단 링크들 -->
        <div class="auth-links">
            <a href="#" id="signup-link">회원가입</a>
            <span class="divider">|</span>
            <a href="#" id="forgot-password-link">비밀번호 찾기</a>
        </div>
        
        <!-- 회원가입 폼 (숨김) -->
        <form id="signup-form" class="auth-form hidden">
            <div class="form-group">
                <input type="text" id="signup-username" placeholder="사용자명" required>
            </div>
            <div class="form-group">
                <input type="email" id="signup-email" placeholder="이메일" required>
            </div>
            <div class="form-group">
                <input type="password" id="signup-password" placeholder="비밀번호 (최소 6자)" required minlength="6">
            </div>
            <div class="form-group">
                <input type="password" id="signup-confirm-password" placeholder="비밀번호 확인" required>
            </div>
            <button type="submit" class="signup-btn">회원가입</button>
            <button type="button" class="back-to-login-btn">로그인으로 돌아가기</button>
        </form>
        
        <!-- 이메일 인증 폼 (숨김) -->
        <form id="email-verification-form" class="auth-form hidden">
            <div class="verification-info">
                <p>이메일로 인증번호를 발송했습니다.</p>
                <p id="verification-email"></p>
            </div>
            <div class="form-group">
                <input type="text" id="email-verification-code" placeholder="인증번호 6자리" maxlength="6" required>
            </div>
            <button type="submit" class="verify-btn">인증 완료</button>
            <button type="button" class="back-to-login-btn">로그인으로 돌아가기</button>
        </form>
        
        <!-- 비밀번호 찾기 폼 (숨김) -->
        <form id="forgot-password-form" class="auth-form hidden">
            <div class="form-group">
                <input type="email" id="forgot-email" placeholder="가입한 이메일" required>
            </div>
            <button type="submit" class="forgot-btn">인증번호 발송</button>
            <button type="button" class="back-to-login-btn">로그인으로 돌아가기</button>
        </form>
        
        <!-- 인증번호 입력 폼 (숨김) -->
        <form id="verify-code-form" class="auth-form hidden">
            <div class="form-group">
                <input type="text" id="verification-code" placeholder="인증번호 6자리" maxlength="6" required>
            </div>
            <div class="form-group">
                <input type="password" id="new-password" placeholder="새 비밀번호" required minlength="6">
            </div>
            <div class="form-group">
                <input type="password" id="confirm-new-password" placeholder="새 비밀번호 확인" required>
            </div>
            <button type="submit" class="verify-btn">비밀번호 변경</button>
            <button type="button" class="back-to-login-btn">로그인으로 돌아가기</button>
        </form>
        
        <div id="auth-message" class="auth-message"></div>
    </div>
    
    <script>
        // 폼 전환 기능
        function showForm(formId) {
            // 모든 폼 숨기기
            document.querySelectorAll('.auth-form, .main-auth-form').forEach(form => {
                form.classList.add('hidden');
            });
            
            // 선택된 폼만 보이기
            const targetForm = document.getElementById(formId);
            if (targetForm) {
                targetForm.classList.remove('hidden');
            }
            
            // 메시지 초기화
            document.getElementById('auth-message').textContent = '';
        }
        
        // 링크 클릭 이벤트
        document.getElementById('signup-link').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('signup-form');
        });
        
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            showForm('forgot-password-form');
        });
        
        // 돌아가기 버튼들
        document.querySelectorAll('.back-to-login-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showForm('login-form');
            });
        });
        
        // 로그인 폼 처리
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (email && password) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 로그인 성공
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        window.location.href = 'index.html';
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    showMessage('로그인 중 오류가 발생했습니다.', 'error');
                }
            }
        });
        
        // 회원가입 폼 처리
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            if (password !== confirmPassword) {
                showMessage('비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            
            if (username && email && password) {
                try {
                    const response = await fetch('/api/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 회원가입 성공, 이메일 인증 단계로
                        document.getElementById('verification-email').textContent = email;
                        showMessage('회원가입이 완료되었습니다. 이메일을 확인해주세요.', 'success');
                        showForm('email-verification-form');
                        this.reset();
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    showMessage('회원가입 중 오류가 발생했습니다.', 'error');
                }
            }
        });
        
        // 이메일 인증 폼 처리
        document.getElementById('email-verification-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('verification-email').textContent;
            const verificationCode = document.getElementById('email-verification-code').value;
            
            try {
                const response = await fetch('/api/verify-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, verificationCode })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('이메일 인증이 완료되었습니다! 로그인해주세요.', 'success');
                    showForm('login-form');
                    this.reset();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('인증 중 오류가 발생했습니다.', 'error');
            }
        });
        
        // 비밀번호 찾기 폼 처리
        document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value.trim();
            
            if (email) {
                try {
                    const response = await fetch('/api/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showMessage('인증번호가 발송되었습니다. 이메일을 확인해주세요.', 'success');
                        showForm('verify-code-form');
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    showMessage('인증번호 발송 중 오류가 발생했습니다.', 'error');
                }
            }
        });
        
        // 인증번호 확인 폼 처리
        document.getElementById('verify-code-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('verification-code').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code, newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('비밀번호가 성공적으로 변경되었습니다.', 'success');
                    showForm('login-form');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('비밀번호 변경 중 오류가 발생했습니다.', 'error');
            }
        });
        
        // 메시지 표시 함수
        function showMessage(text, type) {
            const messageEl = document.getElementById('auth-message');
            messageEl.textContent = text;
            messageEl.className = `auth-message ${type}`;
        }
    </script>
</body>
</html>